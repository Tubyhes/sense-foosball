<html>
<head>
<script type="text/javascript" src="jquery-1.8.1.min.js"></script>
<script type="text/javascript" src="senseapi.js"></script>
<script type="text/javascript" src="md5hash.js"></script>
<script type="text/javascript">

var api = new SenseApi();
var players;
var matches = new Array();
var K = 32;

$(document).ready( function () {
	$("input#submit_password").click(SubmitPasswordHandler);
});

function SubmitPasswordHandler () {
	password = $("input#password").val();
	pwd_hash = calcMD5(password);
	
	if(api.AuthenticateSessionId("sense-foosball", pwd_hash)) {
		GetPlayerList();
		GetMatchList();
		LoadFrontPage();
		$("p#error").html("");
	}
	else {
		$("p#error").html("Wrong password!");
	}
	
}

function GetPlayerList() {
//	171759
	if(api.SensorDataGet(171759, {"last":1})) {
		players = JSON.parse(JSON.parse(api.resp_data).data[0].value);
		console.log(players);
	}
	else {
		$("p#error").html("Cant get player list!");
	}
}

function GetMatchList() {
// 171760
}

function LoadFrontPage () {
	$("div#interaction").html("<form><input type='button' id='1v1' value='1 V 1'></input></form>   <form><input type='button' id='2v2' value='2 V 2'></input></form>");
	$("div#interaction").append(GetPlayerRankingHtml());
	
//	var html_string = " "+
//		"<table>"+
//			"<tr>"+
//				"<td><form><input type='button' id='1v1' value='1 V 1'></input></form></td>"+
//				"<td rowspan=2>"+GetPlayerRankingString+"

	$("input#1v1").click(Load1v1Div);
	$("input#2v2").click(Load2v2Div);
}

function GetPlayerRankingHtml () {
	html_string = "<table>";
	
	var highest_name;
	var highest_score = 10000;
	
	players = players.sort(players_sort);
	
	for (var i=0; i<players.length; i++) {
		html_string += "<tr><td>"+players[i].name+"</td><td>"+players[i].rating+"</td></tr>";
	}
	
	html_string += "</table>";
	
	return html_string;
}

function players_sort (a, b) {
	if (a.rating > b. rating) 
		return -1;
	else if (a.rating < b.rating)
		return 1;
	else
		return 0;
}

function Load1v1Div () {
	$("div#interaction").html("<table><tr><td>Player 1</td><td><input type='text' id='team1_score'></input></td><td>Player 2</td><td><input type='text' id='team2_score'></input></td></tr><tr><td colspan=2>"+getPlayerDropbox('player1')+"</td><td colspan=2>"+getPlayerDropbox('player2')+"</td></tr></table><form><input type='button' id='submit1v1' value='submit'></input></form>		");
	$("input#submit1v1").click(Submit1v1Handler);
}

function Load2v2Div () {
	$("div#interaction").html("<table><tr><td>Team 1</td><td><input type='text' id='team1_score'></input></td><td>Team 2</td><td><input type='text' id='team2_score'></input></td></tr><tr><td>Player 1</td><td>Player 2</td><td>Player 3</td><td>Player 4</td></tr><tr><td>"+getPlayerDropbox('player1')+"</td><td>"+getPlayerDropbox('player2')+"</td><td>"+getPlayerDropbox('player3')+"</td><td>"+getPlayerDropbox('player4')+"</td></tr></table><form><input type='button' id='submit1v1' value='submit'></input></form>		");
	$("input#submit2v2").click(Submit2v2Handler);

}

function Submit1v1Handler () {
	var p1 = $("select#player1").val();
	var p2 = $("select#player2").val();
	
	if (p1 == p2) {
		alert("Select two different players!");
		return;
	}
	
	var score_t1 = parseInt($("input#team1_score").val());
	var score_t2 = parseInt($("input#team2_score").val());
	
	console.log(players[p1].name+" vs "+players[p2].name+": "+score_t1+"-"+score_t2);
	
	var QA = Math.pow(10, players[p1].rating/400);
	var QB = Math.pow(10, players[p2].rating/400);
	var EA = QA/(QA+QB);
	var EB = QA/(QA+QB);
	var SA = (score_t1 > score_t2) ? 1 : 0;
	var SB = 1 - SA;
	var RA = players[p1].rating + K * (SA - EA);
	console.log("QA: "+QA+" EA: "+EA+" SA: "+SA+" RA: "+RA);
	var RB = players[p2].rating + K * (SB - EB);
	console.log("QB: "+QB+" EB: "+EB+" SB: "+SB+" RB: "+RB);
	
	players[p1].rating = RA;
	players[p2].rating = RB;
	
	SubmitNewRatings();
}

function Submit2v2Handler () {

}

function SubmitNewRatings () {
	if (api.SensorDataPost(171759, {"data":[{"value":players}]}))
		LoadFrontPage();
	else 
		alert("Submitting new rankings failed!");
}

function getPlayerDropbox (id) {
	var dropbox_string = "<select id='"+id+"'>"
	
	for (var i=0; i<players.length; i++) {
		dropbox_string += "<option value='"+i+"'>"+players[i].name+"</option>";		
	}
	
	dropbox_string += "</select>";
	
	return dropbox_string
}

</script>

<!--
<style type="text/css">
#interaction {
	vertical-align: middle;
	margin-left: auto;
    margin-right: auto;
    width: 200px;
}
#header {
	text-align: center;
}
#error {
	text-color: red;
}
</style>
-->

</head>

<body>
<h1 id="header">WELCOME TO SENSE FOOSBALL!</h1>
<p id="error"></p>
<div id="interaction" class="interaction">
	<p>Please enter the Sense Foosball password:</p>
	<input type="text" id="password"></input>
	<form><input type="button" id="submit_password" value="Submit Password"></input></form>
</div>
</body>
</html